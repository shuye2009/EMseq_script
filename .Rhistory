#semBP <- godata('org.Hs.eg.db', ont="BP")
df_list <- list()
entrez_list <- list()
for (d in directions){  #
d_list <- lapply(sample_pairs, function(p){
gl <- gene_list[[p]][[d]]
gl <- bitr(gl, "SYMBOL", "ENTREZID", OrgDb="org.Hs.eg.db")
gl$ENTREZID
})
names(d_list) <- comparisons
entrez_list[[d]] <- d_list
dflist_d <- lapply(names(d_list), function(x){
genes <- d_list[[x]]
comparison <- rep(x, length(genes))
direction <- rep(d, length(genes))
df <- data.frame(gene=genes, comparison=comparison, direction=direction)
})
df_list[[d]] <- bind_rows(dflist_d)
}
deg_df <- bind_rows(df_list)
print(dim(deg_df))
print(head(deg_df))
kegg_res <- compareCluster(gene~comparison+direction, data=deg_df, fun="enrichKEGG",
organism="hsa", pvalueCutoff=0.05)
go_res <- compareCluster(gene~comparison+direction, data=deg_df, fun="enrichGO",
OrgDb='org.Hs.eg.db', ont = "BP")
kegg_up <- compareCluster(entrez_list[[directions[1]]], fun="enrichKEGG",
organism="hsa", pvalueCutoff=0.05)
kegg_down <- compareCluster(entrez_list[[directions[2]]], fun="enrichKEGG",
organism="hsa", pvalueCutoff=0.05)
go_up <- compareCluster(entrez_list[[directions[1]]], fun="enrichGO",
OrgDb='org.Hs.eg.db', ont = "BP")
go_down <- compareCluster(entrez_list[[directions[2]]], fun="enrichGO",
OrgDb='org.Hs.eg.db', ont = "BP")
pdf(paste0(c,"_compareCluster.pdf"), height = height, width = width)
if(!is.null(kegg_res)) {
kegg_table <- setReadable(kegg_res, OrgDb = org.Hs.eg.db, keyType="ENTREZID")
write.table(head(kegg_table, n=nrow(kegg_table)), paste0(c, "_KEGG_table.tsv"),
row.names = FALSE, col.names=TRUE, sep="\t", quote = FALSE)
print(dotplot(kegg_res, x="comparison", font.size=10, title="KEGG", label_format=40) + facet_grid(~direction))
print(dotplot(kegg_res, x="direction", font.size=10, title="KEGG", label_format=40) + facet_grid(~comparison))
}
if(!is.null(go_res)) {
go_table <- setReadable(go_res, OrgDb = org.Hs.eg.db, keyType="ENTREZID")
write.table(head(go_table, n=nrow(go_table)), paste0(c, "_GOBP_table.tsv"),
row.names = FALSE, col.names=TRUE, sep="\t", quote = FALSE)
print(dotplot(go_res, x="comparison", font.size=10, title="GO:BP", label_format=40) + facet_grid(~direction))
print(dotplot(go_res, x="direction", font.size=10, title="GO:BP", label_format=40) + facet_grid(~comparison))
}
if(!is.null(go_up)) print(dotplot(go_up, title=paste("GO:BP", directions[1], sep=":")))
if(!is.null(go_down)) print(dotplot(go_down, title=paste("GO:BP", directions[2], sep=":")))
if(!is.null(kegg_up)) print(dotplot(kegg_up, title=paste("KEGG", directions[1], sep=":")))
if(!is.null(kegg_down)) print(dotplot(kegg_down, title=paste("KEGG", directions[2], sep=":")))
dev.off()
}
compareCluster_enrichment <- function(gene_list, comparisons, c="RSEM", height = 10, width = 12){
sample_pairs <- names(gene_list)
directions <- names(gene_list[[1]])
print(comparisons)
print(sample_pairs)
print(directions)
#semBP <- godata('org.Hs.eg.db', ont="BP")
df_list <- list()
entrez_list <- list()
for (d in directions){  #
d_list <- lapply(sample_pairs, function(p){
gl <- gene_list[[p]][[d]]
gl <- bitr(gl, "SYMBOL", "ENTREZID", OrgDb="org.Hs.eg.db")
gl$ENTREZID
})
names(d_list) <- comparisons
entrez_list[[d]] <- d_list
dflist_d <- lapply(names(d_list), function(x){
genes <- d_list[[x]]
comparison <- rep(x, length(genes))
direction <- rep(d, length(genes))
df <- data.frame(gene=genes, comparison=comparison, direction=direction)
})
df_list[[d]] <- bind_rows(dflist_d)
}
deg_df <- bind_rows(df_list)
print(dim(deg_df))
print(head(deg_df))
kegg_res <- compareCluster(gene~comparison+direction, data=deg_df, fun="enrichKEGG",
organism="hsa", pvalueCutoff=0.05)
go_res <- compareCluster(gene~comparison+direction, data=deg_df, fun="enrichGO",
OrgDb='org.Hs.eg.db', ont = "BP")
kegg_up <- compareCluster(entrez_list[[directions[1]]], fun="enrichKEGG",
organism="hsa", pvalueCutoff=0.05)
kegg_down <- compareCluster(entrez_list[[directions[2]]], fun="enrichKEGG",
organism="hsa", pvalueCutoff=0.05)
go_up <- compareCluster(entrez_list[[directions[1]]], fun="enrichGO",
OrgDb='org.Hs.eg.db', ont = "BP")
go_down <- compareCluster(entrez_list[[directions[2]]], fun="enrichGO",
OrgDb='org.Hs.eg.db', ont = "BP")
pdf(paste0(c,"_compareCluster.pdf"), height = height, width = width)
if(!is.null(kegg_res)) {
kegg_table <- setReadable(kegg_res, OrgDb = org.Hs.eg.db, keyType="ENTREZID")
write.table(head(kegg_table, n=nrow(kegg_table)), paste0(c, "_KEGG_table.tsv"),
row.names = FALSE, col.names=TRUE, sep="\t", quote = FALSE)
print(dotplot(kegg_res, x="comparison", font.size=10, title="KEGG", label_format=40) + facet_grid(~direction))
print(dotplot(kegg_res, x="direction", font.size=10, title="KEGG", label_format=40) + facet_grid(~comparison))
}
if(!is.null(go_res)) {
go_table <- setReadable(go_res, OrgDb = org.Hs.eg.db, keyType="ENTREZID")
write.table(head(go_table, n=nrow(go_table)), paste0(c, "_GOBP_table.tsv"),
row.names = FALSE, col.names=TRUE, sep="\t", quote = FALSE)
print(dotplot(go_res, x="comparison", font.size=10, title="GO:BP", label_format=40) + facet_grid(~direction))
print(dotplot(go_res, x="direction", font.size=10, title="GO:BP", label_format=40) + facet_grid(~comparison))
}
if(!is.null(go_up)) print(dotplot(go_up, title=paste("GO:BP", directions[1], sep=":")))
if(!is.null(go_down)) print(dotplot(go_down, title=paste("GO:BP", directions[2], sep=":")))
if(!is.null(kegg_up)) print(dotplot(kegg_up, title=paste("KEGG", directions[1], sep=":")))
if(!is.null(kegg_down)) print(dotplot(kegg_down, title=paste("KEGG", directions[2], sep=":")))
dev.off()
}
compareCluster_enrichment(gene_list, names(gene_list), c="DSS", height = 10, width = 12)
for(aname in names(comparisons)){
wd <- paste0("C:\\PROJECTS\\Shane\\Harding_combined\\local\\DSS_res_", aname)
if(!dir.exists(wd)) dir.create(wd)
setwd(wd)
pdf(paste0("DMR_annotations_", aname, ".pdf"))
dm_file = paste0("DMR_", aname, ".bed")
dm_regions = read_regions(con = dm_file, genome = genome, rename_name = 'DM_status', rename_score = 'areaStat')
dm_regions$DM_status <- ifelse(dm_regions$areaStat>0, "hyper", "hypo")
table(dm_regions$DM_status)
dm_random_regions = randomize_regions(
regions = dm_regions,
allow.overlaps = TRUE,
per.chromosome = TRUE)
# Intersect the regions we read in with the annotations
dm_annotated = annotate_regions(
regions = dm_regions,
annotations = annotations,
ignore.strand = TRUE,
quiet = FALSE)
# A GRanges object is returned
print(dm_annotated)
# Coerce to a data.frame
df_dm_annotated = data.frame(dm_annotated)
# Perform enrichment analysis
directions <- c("hyper", "hypo")
dm_genes <- lapply(directions, function(x){
dm_gene <- df_dm_annotated |>
filter(DM_status == x) |>
filter(!is.na(annot.symbol)) |>
pull(annot.symbol) |>
unique()
})
names(dm_genes) <- directions
gene_list <- list()
gene_list[[aname]] <- dm_genes
compareCluster_enrichment(gene_list, names(gene_list), c="DSS", height = 10, width = 6)
# See the GRanges column of dm_annotaed expanded
print(head(df_dm_annotated, n=50))
dm_random_annotated = annotate_regions(
regions = dm_random_regions,
annotations = annotations,
ignore.strand = TRUE,
quiet = TRUE)
# Find the number of regions per annotation type
dm_annsum_rnd = summarize_annotations(
annotated_regions = dm_annotated,
annotated_random = dm_random_annotated,
quiet = TRUE)
print(dm_annsum_rnd)
# View the number of regions per annotation and include the annotation
# of randomized regions
annots_order = c(
'hg38_cpg_islands',
'hg38_cpg_shores',
'hg38_cpg_shelves',
'hg38_cpg_inter',
'hg38_genes_1to5kb',
'hg38_genes_promoters',
'hg38_genes_5UTRs',
'hg38_genes_exons',
'hg38_genes_introns',
'hg38_genes_3UTRs',
'hg38_genes_intergenic',
'hg38_lncrna_gencode')
dm_vs_kg_annotations_wrandom = plot_annotation(
annotated_regions = dm_annotated,
annotated_random = dm_random_annotated,
annotation_order = annots_order,
plot_title = 'Dist. of Sites Tested for DM (with rndm.)',
x_label = 'Annotations',
y_label = 'Count')
print(dm_vs_kg_annotations_wrandom)
# View the counts of CpG annotations in data classes
# The orders for the x-axis labels. This is also a subset
# of the labels (hyper, hypo, none).
x_order = c(
'hyper',
'hypo')
# The orders for the fill labels. Can also use this
# parameter to subset annotation types to fill.
fill_order = c(
'hg38_cpg_islands',
'hg38_cpg_shores',
'hg38_cpg_shelves',
'hg38_cpg_inter')
# Make a barplot of the data class where each bar
# is composed of the counts of CpG annotations.
dm_vs_cpg_cat1 = plot_categorical(
annotated_regions = dm_annotated,
annotated_random = dm_random_annotated,
x='DM_status', fill='annot.type',
x_order = x_order, fill_order = fill_order, position='stack',
plot_title = 'DM Status by CpG Annotation Counts',
legend_title = 'Annotations',
x_label = 'DM status',
y_label = 'Count')
print(dm_vs_cpg_cat1)
# View the proportions of data classes in knownGene annotations
# The orders for the x-axis labels.
x_order = c(
'hg38_genes_1to5kb',
'hg38_genes_promoters',
'hg38_genes_5UTRs',
'hg38_genes_exons',
'hg38_genes_introns',
'hg38_genes_3UTRs',
'hg38_genes_intergenic')
# The orders for the fill labels.
fill_order = c(
'hyper',
'hypo')
dm_vs_kg_cat = plot_categorical(
annotated_regions = dm_annotated, x='annot.type', fill='DM_status',
x_order = x_order, fill_order = fill_order, position='stack',
legend_title = 'DM Status',
x_label = 'knownGene Annotations',
y_label = 'Count')
print(dm_vs_kg_cat)
dev.off()
}
dev.off()
for(aname in names(comparisons)){
wd <- paste0("C:\\PROJECTS\\Shane\\Harding_combined\\local\\DSS_res_", aname)
if(!dir.exists(wd)) dir.create(wd)
setwd(wd)
pdf(paste0("DMR_annotations_", aname, ".pdf"))
dm_file = paste0("DMR_", aname, ".bed")
dm_regions = read_regions(con = dm_file, genome = genome, rename_name = 'DM_status', rename_score = 'areaStat')
dm_regions$DM_status <- ifelse(dm_regions$areaStat>0, "hyper", "hypo")
table(dm_regions$DM_status)
dm_random_regions = randomize_regions(
regions = dm_regions,
allow.overlaps = TRUE,
per.chromosome = TRUE)
# Intersect the regions we read in with the annotations
dm_annotated = annotate_regions(
regions = dm_regions,
annotations = annotations,
ignore.strand = TRUE,
quiet = FALSE)
# A GRanges object is returned
print(dm_annotated)
# Coerce to a data.frame
df_dm_annotated = data.frame(dm_annotated)
# Perform enrichment analysis
directions <- c("hyper", "hypo")
dm_genes <- lapply(directions, function(x){
dm_gene <- df_dm_annotated |>
filter(DM_status == x) |>
filter(!is.na(annot.symbol)) |>
pull(annot.symbol) |>
unique()
})
names(dm_genes) <- directions
gene_list <- list()
gene_list[[aname]] <- dm_genes
compareCluster_enrichment(gene_list, names(gene_list), c="DSS", height = 10, width = 6)
# See the GRanges column of dm_annotaed expanded
print(head(df_dm_annotated, n=50))
dm_random_annotated = annotate_regions(
regions = dm_random_regions,
annotations = annotations,
ignore.strand = TRUE,
quiet = TRUE)
# Find the number of regions per annotation type
dm_annsum_rnd = summarize_annotations(
annotated_regions = dm_annotated,
annotated_random = dm_random_annotated,
quiet = TRUE)
print(dm_annsum_rnd)
# View the number of regions per annotation and include the annotation
# of randomized regions
annots_order = c(
'hg38_cpg_islands',
'hg38_cpg_shores',
#'hg38_cpg_shelves',
'hg38_cpg_inter',
'hg38_genes_1to5kb',
'hg38_genes_promoters',
'hg38_genes_5UTRs',
'hg38_genes_exons',
'hg38_genes_introns',
'hg38_genes_3UTRs',
'hg38_genes_intergenic',
'hg38_lncrna_gencode')
dm_vs_kg_annotations_wrandom = plot_annotation(
annotated_regions = dm_annotated,
annotated_random = dm_random_annotated,
annotation_order = annots_order,
plot_title = 'Dist. of Sites Tested for DM (with rndm.)',
x_label = 'Annotations',
y_label = 'Count')
print(dm_vs_kg_annotations_wrandom)
# View the counts of CpG annotations in data classes
# The orders for the x-axis labels. This is also a subset
# of the labels (hyper, hypo, none).
x_order = c(
'hyper',
'hypo')
# The orders for the fill labels. Can also use this
# parameter to subset annotation types to fill.
fill_order = c(
'hg38_cpg_islands',
'hg38_cpg_shores',
#'hg38_cpg_shelves',
'hg38_cpg_inter')
# Make a barplot of the data class where each bar
# is composed of the counts of CpG annotations.
dm_vs_cpg_cat = plot_categorical(
annotated_regions = dm_annotated,
annotated_random = dm_random_annotated,
x='DM_status', fill='annot.type',
x_order = x_order, fill_order = fill_order, position='stack',
plot_title = 'DM Status by CpG Annotation Counts',
legend_title = 'Annotations',
x_label = 'DM status',
y_label = 'Count')
print(dm_vs_cpg_cat)
# View the proportions of data classes in knownGene annotations
# The orders for the x-axis labels.
x_order = c(
'hg38_genes_1to5kb',
'hg38_genes_promoters',
'hg38_genes_5UTRs',
'hg38_genes_exons',
'hg38_genes_introns',
'hg38_genes_3UTRs',
'hg38_genes_intergenic')
# The orders for the fill labels.
fill_order = c(
'hyper',
'hypo')
dm_vs_kg_cat = plot_categorical(
annotated_regions = dm_annotated, x='annot.type', fill='DM_status',
x_order = x_order, fill_order = fill_order, position='stack',
legend_title = 'DM Status',
x_label = 'knownGene Annotations',
y_label = 'Count')
print(dm_vs_kg_cat)
dev.off()
}
plot_categorical
for(aname in names(comparisons)){
wd <- paste0("C:\\PROJECTS\\Shane\\Harding_combined\\local\\DSS_res_", aname)
if(!dir.exists(wd)) dir.create(wd)
setwd(wd)
pdf(paste0("DMR_annotations_", aname, ".pdf"))
dm_file = paste0("DMR_", aname, ".bed")
dm_regions = read_regions(con = dm_file, genome = genome, rename_name = 'DM_status', rename_score = 'areaStat')
dm_regions$DM_status <- ifelse(dm_regions$areaStat>0, "hyper", "hypo")
table(dm_regions$DM_status)
dm_random_regions = randomize_regions(
regions = dm_regions,
allow.overlaps = TRUE,
per.chromosome = TRUE)
# Intersect the regions we read in with the annotations
dm_annotated = annotate_regions(
regions = dm_regions,
annotations = annotations,
ignore.strand = TRUE,
quiet = FALSE)
# A GRanges object is returned
print(dm_annotated)
# Coerce to a data.frame
df_dm_annotated = data.frame(dm_annotated)
# Perform enrichment analysis
directions <- c("hyper", "hypo")
dm_genes <- lapply(directions, function(x){
dm_gene <- df_dm_annotated |>
filter(DM_status == x) |>
filter(!is.na(annot.symbol)) |>
pull(annot.symbol) |>
unique()
})
names(dm_genes) <- directions
gene_list <- list()
gene_list[[aname]] <- dm_genes
compareCluster_enrichment(gene_list, names(gene_list), c="DSS", height = 10, width = 6)
# See the GRanges column of dm_annotaed expanded
print(head(df_dm_annotated, n=50))
dm_random_annotated = annotate_regions(
regions = dm_random_regions,
annotations = annotations,
ignore.strand = TRUE,
quiet = TRUE)
# Find the number of regions per annotation type
dm_annsum_rnd = summarize_annotations(
annotated_regions = dm_annotated,
annotated_random = dm_random_annotated,
quiet = TRUE)
print(dm_annsum_rnd)
# View the number of regions per annotation and include the annotation
# of randomized regions
annots_order = c(
'hg38_cpg_islands',
'hg38_cpg_shores',
'hg38_cpg_shelves',
'hg38_cpg_inter',
'hg38_genes_1to5kb',
'hg38_genes_promoters',
'hg38_genes_5UTRs',
'hg38_genes_exons',
'hg38_genes_introns',
'hg38_genes_3UTRs',
'hg38_genes_intergenic',
'hg38_lncrna_gencode')
dm_vs_kg_annotations_wrandom = plot_annotation(
annotated_regions = dm_annotated,
annotated_random = dm_random_annotated,
annotation_order = annots_order,
plot_title = 'Dist. of Sites Tested for DM (with rndm.)',
x_label = 'Annotations',
y_label = 'Count')
print(dm_vs_kg_annotations_wrandom)
# View the counts of CpG annotations in data classes
# The orders for the x-axis labels. This is also a subset
# of the labels (hyper, hypo, none).
x_order = c(
'hyper',
'hypo')
# The orders for the fill labels. Can also use this
# parameter to subset annotation types to fill.
fill_order = c(
'hg38_cpg_islands',
'hg38_cpg_shores',
'hg38_cpg_shelves',
'hg38_cpg_inter')
# Make a barplot of the data class where each bar
# is composed of the counts of CpG annotations.
dm_vs_cpg_cat = plot_categorical(
annotated_regions = dm_annotated,
annotated_random = dm_random_annotated,
x='DM_status', fill='annot.type',
x_order = x_order, fill_order = fill_order, position='stack',
plot_title = 'DM Status by CpG Annotation Counts',
legend_title = 'Annotations',
x_label = 'DM status',
y_label = 'Count')
print(dm_vs_cpg_cat)
# View the proportions of data classes in knownGene annotations
# The orders for the x-axis labels.
x_order = c(
'hg38_genes_1to5kb',
'hg38_genes_promoters',
'hg38_genes_5UTRs',
'hg38_genes_exons',
'hg38_genes_introns',
'hg38_genes_3UTRs',
'hg38_genes_intergenic')
# The orders for the fill labels.
fill_order = c(
'hyper',
'hypo')
dm_vs_kg_cat = plot_categorical(
annotated_regions = dm_annotated, x='annot.type', fill='DM_status',
x_order = x_order, fill_order = fill_order, position='stack',
legend_title = 'DM Status',
x_label = 'knownGene Annotations',
y_label = 'Count')
print(dm_vs_kg_cat)
dev.off()
}
library(devtools)
install_github("JmWangBio/ComBatMet")
# two factor model analysis of dmr #
library(DSS)
library(bsseq)
library(comethyl)
library(dplyr)
library(BiocFileCache)
library(GenomicPlot)
library(annotatr)
# fetch gtf file ####
genome <- "hg38"
bfc <- BiocFileCache()
if(genome == "hg38"){
url <- "https://ftp.ebi.ac.uk/pub/databases/gencode/Gencode_human/release_45/gencode.v45.primary_assembly.annotation.gtf.gz"
}else if(genome == "hg38"){
url <- "https://ftp.ebi.ac.uk/pub/databases/gencode/Gencode_human/release_19/gencode.v19.annotation.gtf.gz"
}else{
stop("Genome is not supported!")
}
gz <- bfcrpath(bfc, url)
gtfFile <- gsub(".gz", "", gz)
if(!file.exists(gtfFile)) gtfFile <- R.utils::gunzip(gz, remove=FALSE)
# load bs ####
bsdir <- "C:\\PROJECTS\\Shane\\Harding_combined\\local\\DMRcate_res"
bs <- readRDS(file.path(bsdir, "bs.RDS"))
colnames(bs) <- sapply((strsplit(colnames(bs), split=".", fixed = T)), function(x)x[1])
if (!require("BiocManager", quietly = TRUE))
install.packages("BiocManager")
BiocManager::install("methylKit")
library(methylKit)
standardChr <- c(paste0("chr", seq.int(22)), "chrX", "chrY")
bs <- bs[seqnames(bs) %in% standardChr, ] # remove non-standard chromosomes
